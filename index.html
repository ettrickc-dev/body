<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Conversation Function Trainer (Logistics / Connection / Boundary / Venting / Identity)</title>
  <style>
    :root { --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6edf3; --accent:#6ee7ff; --good:#4ade80; --bad:#fb7185; --warn:#fbbf24; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background: radial-gradient(1200px 800px at 20% 10%, #132033 0%, var(--bg) 55%); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title { font-weight:800; letter-spacing:.2px; font-size: 18px; }
    .subtitle { color:var(--muted); font-size: 13px; margin-top:4px; }
    .row { display:grid; grid-template-columns: 1.25fr .75fr; gap: 14px; margin-top: 14px; }
    @media (max-width: 900px){ .row{ grid-template-columns:1fr; } }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border: 1px solid rgba(255,255,255,.10); border-radius: 18px; padding: 14px; box-shadow: 0 14px 40px rgba(0,0,0,.30); }
    .card h3 { margin: 0 0 8px; font-size: 14px; color: #d7e2ee; }
    .mini { color:var(--muted); font-size: 12px; line-height: 1.35; }
    .scenarioBox { border-radius: 16px; background: rgba(0,0,0,.28); border: 1px solid rgba(255,255,255,.08); padding: 14px; min-height: 120px; display:flex; flex-direction:column; gap: 10px; }
    .who { display:flex; align-items:center; justify-content:space-between; gap:10px; color: var(--muted); font-size: 12px; }
    .msg { font-size: 20px; line-height: 1.25; font-weight: 750; letter-spacing: .1px; }
    .tag { font-size: 11px; padding: 6px 10px; border-radius: 999px; background: rgba(110,231,255,.12); color: var(--accent); border: 1px solid rgba(110,231,255,.25); }
    .grid5 { display:grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 12px; }
    @media (max-width: 900px){ .grid5{ grid-template-columns:1fr; } }
    button { cursor:pointer; border:none; border-radius: 14px; padding: 12px 10px; font-weight: 800; color: var(--text); background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.10); transition: transform .05s ease, background .15s ease, border .15s ease; }
    button:hover { background: rgba(255,255,255,.12); }
    button:active { transform: translateY(1px); }
    .btnGood { background: rgba(74,222,128,.12); border-color: rgba(74,222,128,.25); }
    .btnBad { background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.25); }
    .btnWarn { background: rgba(251,191,36,.12); border-color: rgba(251,191,36,.25); }
    .controls { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    @media (max-width: 900px){ .controls{ grid-template-columns:1fr; } }
    .kv { display:flex; align-items:center; justify-content:space-between; gap: 10px; padding: 10px 12px; border-radius: 14px; background: rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.08); }
    .kv span { color: var(--muted); font-size: 12px; }
    .kv b { font-size: 14px; }
    .pillrow { display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .pill { display:flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 999px; background: rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.08); color: var(--muted); font-size: 12px; }
    .pill input[type="checkbox"]{ transform: scale(1.15); }
    .divider { height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .result { border-radius: 16px; padding: 12px; background: rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.08); margin-top: 12px; display:none; }
    .result.good { border-color: rgba(74,222,128,.30); }
    .result.bad { border-color: rgba(251,113,133,.30); }
    .result h4 { margin:0 0 6px; font-size: 13px; }
    .result p { margin: 0; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .bigAnswer { margin-top: 10px; display:grid; gap: 10px; }
    .answerRow { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 900px){ .answerRow { grid-template-columns:1fr; } }
    .input { width:100%; border-radius: 14px; padding: 12px 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); color: var(--text); outline:none; font-weight: 700; }
    .input::placeholder{ color: rgba(154,164,178,.75); font-weight: 600; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.10); color: var(--text); }
    .footer { margin-top: 14px; color: var(--muted); font-size: 12px; line-height: 1.35; }
    .tiny { font-size: 11px; color: rgba(154,164,178,.9); }
    .modeTabs { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .modeTabs button { padding: 10px 12px; border-radius: 999px; font-weight: 900; }
    .activeTab { background: rgba(110,231,255,.14); border-color: rgba(110,231,255,.28); }
    .speakBtn { display:flex; align-items:center; justify-content:center; gap:8px; }
    .meter { height: 8px; border-radius: 999px; background: rgba(255,255,255,.08); overflow:hidden; border: 1px solid rgba(255,255,255,.10); }
    .meter > div { height:100%; width:0%; background: rgba(110,231,255,.70); }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <div class="title">Conversation Function Trainer</div>
      <div class="subtitle">Train the 5-function reflex fast ‚Äî works for text or speech. Keyboard: <span class="kbd">1</span>-<span class="kbd">5</span> to answer, <span class="kbd">N</span> next, <span class="kbd">Space</span> speak.</div>
    </div>
    <div class="kv" style="min-width:260px;">
      <span>Mode</span>
      <b id="modeLabel">Classify</b>
    </div>
  </div>

  <div class="row">
    <!-- MAIN TRAINER -->
    <div class="card">
      <h3>Live Scenario</h3>
      <div class="scenarioBox">
        <div class="who">
          <div>
            <span class="tag" id="speedTag">Speed: Normal</span>
            <span class="tag" id="timerTag" style="margin-left:6px;">Timer: Off</span>
          </div>
          <div class="tiny">Goal: Identify the function, then answer in 1 unit.</div>
        </div>
        <div class="msg" id="msgText">Click ‚ÄúNext‚Äù to begin.</div>

        <div class="controls">
          <button id="nextBtn" class="btnGood">Next Scenario (<span class="kbd">N</span>)</button>
          <button id="speakBtn" class="speakBtn btnWarn">Speak It (<span class="kbd">Space</span>)</button>
        </div>

        <div class="grid5" id="answerButtons">
          <button data-f="LOGISTICS">1) Logistics</button>
          <button data-f="CONNECTION">2) Connection</button>
          <button data-f="BOUNDARY">3) Boundary</button>
          <button data-f="VENTING">4) Venting</button>
          <button data-f="IDENTITY">5) Identity</button>
        </div>

        <div class="result" id="resultBox">
          <h4 id="resultTitle">Result</h4>
          <p id="resultExplain"></p>
          <div class="divider"></div>
          <div class="bigAnswer">
            <div class="answerRow">
              <div>
                <div class="mini"><b>Best ‚ÄúOne-Unit‚Äù reply (memorize)</b></div>
                <input class="input" id="bestReply" readonly />
              </div>
              <div>
                <div class="mini"><b>Your reply (optional practice)</b></div>
                <input class="input" id="yourReply" placeholder="Type your one-sentence reply‚Ä¶" />
              </div>
            </div>
            <div class="mini" id="microCoach"></div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="mini"><b>Progress</b></div>
          <div class="meter"><div id="meterFill"></div></div>
          <div class="pillrow">
            <div class="pill">Streak: <b id="streak">0</b></div>
            <div class="pill">Correct: <b id="correct">0</b></div>
            <div class="pill">Attempts: <b id="attempts">0</b></div>
            <div class="pill">Avg Time: <b id="avgTime">‚Äî</b></div>
          </div>
        </div>
      </div>

      <div class="footer">
        <b>Reflex Rule:</b> Identify the function ‚Üí serve the function ‚Üí stop. <br/>
        <span class="tiny">This app ramps speed and time pressure so you can handle fast talkers.</span>
      </div>
    </div>

    <!-- SETTINGS / TRAINING -->
    <div class="card">
      <h3>Training Settings</h3>

      <div class="modeTabs">
        <button id="tabClassify" class="activeTab">Classify</button>
        <button id="tabReply">Reply Builder</button>
        <button id="tabPressure">Pressure Mode</button>
      </div>

      <div class="divider"></div>

      <div class="kv">
        <span>Difficulty</span>
        <b id="diffLabel">Level 1</b>
      </div>
      <div class="mini" style="margin:8px 0 10px;">
        Level rises automatically as your streak grows: shorter time, faster speech, more ambiguous scenarios.
      </div>

      <div class="kv">
        <span>Speech speed</span>
        <b><span id="rateLabel">1.0√ó</span></b>
      </div>
      <input id="rate" type="range" min="0.7" max="1.6" step="0.05" value="1.0" style="width:100%; margin-top:10px;"/>

      <div class="kv" style="margin-top:10px;">
        <span>Timer (seconds)</span>
        <b><span id="timeLabel">Off</span></b>
      </div>
      <input id="timer" type="range" min="0" max="12" step="1" value="0" style="width:100%; margin-top:10px;"/>

      <div class="divider"></div>

      <div class="mini"><b>Focus Functions</b> (turn off anything you want to drill)</div>
      <div class="pillrow">
        <label class="pill"><input type="checkbox" class="focus" value="LOGISTICS" checked/> Logistics</label>
        <label class="pill"><input type="checkbox" class="focus" value="CONNECTION" checked/> Connection</label>
        <label class="pill"><input type="checkbox" class="focus" value="BOUNDARY" checked/> Boundary</label>
        <label class="pill"><input type="checkbox" class="focus" value="VENTING" checked/> Venting</label>
        <label class="pill"><input type="checkbox" class="focus" value="IDENTITY" checked/> Identity</label>
      </div>

      <div class="divider"></div>

      <div class="mini"><b>3 Hidden Questions Check</b> (use in real life)</div>
      <div class="scenarioBox" style="min-height:auto;">
        <div class="mini">Before you reply, silently ensure your reply answers:</div>
        <div class="pillrow">
          <div class="pill">‚úî Understand</div>
          <div class="pill">‚úî Respect</div>
          <div class="pill">‚úî Steady</div>
        </div>
        <div class="mini">If you‚Äôre unsure, send <b>ONE sentence</b> and stop.</div>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== DATA ======
  const FUNCTIONS = ["LOGISTICS","CONNECTION","BOUNDARY","VENTING","IDENTITY"];

  // High-frequency real-life scenarios (text OR speech). Each has: msg, function, why, bestReply, coaching.
  // Designed to include ambiguity so you learn fast classification under pressure.
  const BANK = [
    // LOGISTICS
    {f:"LOGISTICS", msg:"What time are we meeting?", why:"They want a time. Pure coordination.", best:"3pm. I‚Äôll confirm the location now.", coach:"Answer clearly, confirm one action, stop."},
    {f:"LOGISTICS", msg:"Send me the address when you get a chance.", why:"Request for info.", best:"Got it ‚Äî sending the address now.", coach:"No extra emotion. Just do it."},
    {f:"LOGISTICS", msg:"I can call after work around 6.", why:"Scheduling.", best:"Perfect. I‚Äôll be free at 6.", coach:"Confirm. Done."},
    {f:"LOGISTICS", msg:"Do you have that document handy?", why:"Needs the item.", best:"Yes ‚Äî I‚Äôll forward it now.", coach:"Straight answer + action."},
    {f:"LOGISTICS", msg:"Remind me what the plan is for tomorrow.", why:"They need the outline.", best:"Plan: 10am call, then we handle the rest after.", coach:"Keep it short; bullet-like."},

    // CONNECTION
    {f:"CONNECTION", msg:"How was your day?", why:"Seeking closeness and attention, not facts.", best:"Busy but good. How about yours?", coach:"Match warmth + return question (one hook)."},
    {f:"CONNECTION", msg:"LOL you‚Äôre funny.", why:"Playful bid for connection.", best:"I try üòÑ What are you up to tonight?", coach:"Keep it light, add a small hook."},
    {f:"CONNECTION", msg:"You‚Äôve been on my mind.", why:"Closeness cue.", best:"I like hearing that. What made you think of me?", coach:"Warm + one simple opener."},
    {f:"CONNECTION", msg:"Send me a pic of what you‚Äôre doing.", why:"Wants inclusion and shared moment.", best:"Here you go. What are you doing right now?", coach:"Share + invite them back in."},
    {f:"CONNECTION", msg:"You disappeared on me üòÖ", why:"Soft complaint = connection repair.", best:"Fair üòÑ Today got hectic. How‚Äôs your evening going?", coach:"Light accountability + reconnect."},

    // BOUNDARY
    {f:"BOUNDARY", msg:"I‚Äôm really busy this week.", why:"Pacing/space. Not asking for solutions.", best:"Understood.", coach:"Respect immediately. Don‚Äôt chase."},
    {f:"BOUNDARY", msg:"No pressure, but I might not make it.", why:"Protecting space/expectations.", best:"No worries at all.", coach:"Accept it cleanly. No persuasion."},
    {f:"BOUNDARY", msg:"I don‚Äôt like going back and forth over text.", why:"Setting communication boundary.", best:"Got it. We can talk later instead.", coach:"Respect and offer a simple alternative."},
    {f:"BOUNDARY", msg:"I need some time to myself today.", why:"Space request.", best:"Understood. Talk when you‚Äôre ready.", coach:"Short + respectful + stop."},
    {f:"BOUNDARY", msg:"Let‚Äôs not make this a big thing.", why:"Boundary against intensity.", best:"Agreed.", coach:"Align. Don‚Äôt escalate."},

    // VENTING
    {f:"VENTING", msg:"I‚Äôm exhausted. Everything is on me.", why:"Emotional release; they want to be heard.", best:"That sounds draining. Want to vent or reset for a bit?", coach:"Mirror + validate + small option (don‚Äôt fix)."},
    {f:"VENTING", msg:"People are getting on my nerves today.", why:"Stress dump.", best:"I hear you. What happened?", coach:"Reflect + one gentle question."},
    {f:"VENTING", msg:"I can‚Äôt catch a break lately.", why:"Venting, seeking acknowledgment.", best:"That‚Äôs a lot. What‚Äôs been the hardest part?", coach:"Validate + narrow to one piece."},
    {f:"VENTING", msg:"I‚Äôm overwhelmed and I don‚Äôt even know where to start.", why:"They need containment, not a lecture.", best:"I hear you. Want me to help you pick the first step?", coach:"Offer one small option, not a full plan."},
    {f:"VENTING", msg:"Nothing ever goes right for me.", why:"Emotional statement; not literal.", best:"That sounds heavy. I‚Äôm listening.", coach:"Don‚Äôt argue facts. Hold space."},

    // IDENTITY
    {f:"IDENTITY", msg:"I‚Äôm the type of person who keeps moving forward no matter what.", why:"Self-definition. Wants respect, not pity.", best:"I respect that. You‚Äôre very deliberate about how you show up.", coach:"Mirror + respect. No pity. No fixing."},
    {f:"IDENTITY", msg:"I don‚Äôt do drama.", why:"Value statement.", best:"I respect that.", coach:"Agree with the frame."},
    {f:"IDENTITY", msg:"I‚Äôve always handled things myself.", why:"Agency statement.", best:"I can see that. You‚Äôre very self-directed.", coach:"Recognize agency; don‚Äôt rescue."},
    {f:"IDENTITY", msg:"I value loyalty above everything.", why:"Value disclosure.", best:"That‚Äôs clear. Loyalty matters to you ‚Äî I respect it.", coach:"Mirror and respect; keep it simple."},
    {f:"IDENTITY", msg:"I don‚Äôt like being pitied.", why:"Boundary + identity.", best:"Understood. I respect you ‚Äî no pity.", coach:"Confirm boundary and restore dignity."},

    // Ambiguous / mixed (to train speed)
    {f:"BOUNDARY", msg:"I can‚Äôt talk right now.", why:"Boundary; immediate.", best:"Understood.", coach:"No follow-up questions."},
    {f:"LOGISTICS", msg:"Call me when you‚Äôre free.", why:"Scheduling request disguised as connection.", best:"I‚Äôm free at 6 ‚Äî I‚Äôll call then.", coach:"Treat as logistics: propose a time."},
    {f:"VENTING", msg:"I‚Äôm fine. Just tired.", why:"Often venting-lite; they want acknowledgment.", best:"Got you. Want to rest or talk for a minute?", coach:"Small option, no interrogation."},
    {f:"CONNECTION", msg:"You‚Äôre quiet today.", why:"Connection check.", best:"Yeah ‚Äî long day. How are you doing?", coach:"Brief + return to them."},
    {f:"IDENTITY", msg:"I need to stay focused. My kids depend on me.", why:"Identity + responsibility.", best:"That makes sense. I respect how focused you are.", coach:"Mirror responsibility; no pity."}
  ];

  // ====== STATE ======
  let active = null;
  let streak = 0, correct = 0, attempts = 0;
  let times = []; // ms
  let level = 1;
  let timerId = null;
  let startedAt = null;

  // Mode: classify | reply | pressure (affects feedback rules)
  let mode = "classify";

  // ====== DOM ======
  const msgText = document.getElementById("msgText");
  const resultBox = document.getElementById("resultBox");
  const resultTitle = document.getElementById("resultTitle");
  const resultExplain = document.getElementById("resultExplain");
  const bestReply = document.getElementById("bestReply");
  const yourReply = document.getElementById("yourReply");
  const microCoach = document.getElementById("microCoach");

  const streakEl = document.getElementById("streak");
  const correctEl = document.getElementById("correct");
  const attemptsEl = document.getElementById("attempts");
  const avgTimeEl = document.getElementById("avgTime");
  const meterFill = document.getElementById("meterFill");

  const diffLabel = document.getElementById("diffLabel");
  const speedTag = document.getElementById("speedTag");
  const timerTag = document.getElementById("timerTag");

  const rateSlider = document.getElementById("rate");
  const rateLabel = document.getElementById("rateLabel");
  const timerSlider = document.getElementById("timer");
  const timeLabel = document.getElementById("timeLabel");

  const modeLabel = document.getElementById("modeLabel");
  const tabClassify = document.getElementById("tabClassify");
  const tabReply = document.getElementById("tabReply");
  const tabPressure = document.getElementById("tabPressure");

  // ====== HELPERS ======
  function getFocusSet(){
    const checks = [...document.querySelectorAll(".focus")];
    const on = checks.filter(c=>c.checked).map(c=>c.value);
    return new Set(on.length ? on : FUNCTIONS);
  }

  function pickScenario(){
    const focus = getFocusSet();
    // Level increases ambiguity: later levels sample more mixed items by random shuffle anyway.
    const pool = BANK.filter(x=>focus.has(x.f));
    if(!pool.length) return null;

    // Weighted to include more ambiguous as level rises
    // We'll treat items near end as "harder" (we placed ambiguous near end).
    const hardStart = Math.max(0, pool.length - 8);
    const hardPool = pool.slice(hardStart);
    const easyPool = pool.slice(0, hardStart);

    const hardChance = Math.min(0.15 + (level-1)*0.08, 0.70);
    const useHard = Math.random() < hardChance && hardPool.length;

    const chosenPool = useHard ? hardPool : easyPool.length ? easyPool : hardPool;
    return chosenPool[Math.floor(Math.random()*chosenPool.length)];
  }

  function setLevel(){
    // Level based on streak and accuracy
    // Each 5 streak -> +1 level up to 8
    level = Math.min(8, 1 + Math.floor(streak / 5));
    diffLabel.textContent = `Level ${level}`;
    // Auto tighten timer in pressure mode if user hasn't set one
    if(mode === "pressure" && parseInt(timerSlider.value,10) === 0){
      const auto = Math.max(3, 10 - level); // 9..3 seconds
      timerSlider.value = auto;
      updateTimerLabel();
    }
    updateSpeedTag();
  }

  function updateStats(){
    streakEl.textContent = String(streak);
    correctEl.textContent = String(correct);
    attemptsEl.textContent = String(attempts);

    if(times.length){
      const avg = times.reduce((a,b)=>a+b,0)/times.length;
      avgTimeEl.textContent = `${(avg/1000).toFixed(2)}s`;
    } else {
      avgTimeEl.textContent = "‚Äî";
    }

    // meter tracks progress toward next level (streak mod 5)
    const prog = (streak % 5) / 5 * 100;
    meterFill.style.width = `${prog}%`;
  }

  function showResult(isCorrect, picked){
    resultBox.style.display = "block";
    resultBox.classList.remove("good","bad");
    resultBox.classList.add(isCorrect ? "good" : "bad");

    const fnNice = {
      LOGISTICS:"Logistics",
      CONNECTION:"Connection",
      BOUNDARY:"Boundary / Control",
      VENTING:"Venting / Emotional Release",
      IDENTITY:"Identity Statement"
    };

    if(isCorrect){
      resultTitle.textContent = `Correct ‚Äî ${fnNice[active.f]}`;
      resultExplain.textContent = `${active.why}`;
    } else {
      resultTitle.textContent = `Not quite ‚Äî it was ${fnNice[active.f]}`;
      resultExplain.textContent = `Why: ${active.why} (You picked: ${fnNice[picked] || picked})`;
    }

    bestReply.value = active.best;

    // Micro-coaching for user's typed reply (optional)
    microCoach.innerHTML = `<b>Coach:</b> ${active.coach} <span class="tiny">| Real-life rule: one function, one unit, stop.</span>`;
  }

  function clearResult(){
    resultBox.style.display = "none";
    yourReply.value = "";
  }

  function startTimerIfNeeded(){
    stopTimer();
    const secs = parseInt(timerSlider.value,10);
    if(!active || secs<=0) return;

    timerTag.textContent = `Timer: ${secs}s`;
    let left = secs;
    timerId = setInterval(()=>{
      left--;
      timerTag.textContent = `Timer: ${left}s`;
      if(left <= 0){
        stopTimer();
        // Auto mark incorrect if user didn't answer yet
        // Only if startedAt exists and no result shown
        if(startedAt && resultBox.style.display !== "block"){
          // In pressure mode, missing is a fail and resets streak
          attempts++;
          streak = 0;
          setLevel();
          updateStats();
          showResult(false, "No answer (time)");
          startedAt = null;
        }
      }
    }, 1000);
  }

  function stopTimer(){
    if(timerId){ clearInterval(timerId); timerId = null; }
    const secs = parseInt(timerSlider.value,10);
    timerTag.textContent = secs>0 ? `Timer: ${secs}s` : "Timer: Off";
  }

  function updateSpeedTag(){
    // rate slider sets base. level increases difficulty by suggesting "faster speakers".
    const base = parseFloat(rateSlider.value);
    const effective = Math.min(1.8, base + (mode==="pressure" ? (level-1)*0.05 : 0));
    speedTag.textContent = `Speed: ${effective.toFixed(2)}√ó`;
  }

  function updateTimerLabel(){
    const v = parseInt(timerSlider.value,10);
    timeLabel.textContent = v === 0 ? "Off" : `${v}s`;
    timerTag.textContent = v === 0 ? "Timer: Off" : `Timer: ${v}s`;
  }

  function speakCurrent(){
    if(!active) return;
    if(!("speechSynthesis" in window)) {
      alert("Speech synthesis not supported in this browser.");
      return;
    }
    // cancel any prior
    window.speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(active.msg);
    const base = parseFloat(rateSlider.value);
    const effective = Math.min(1.8, base + (mode==="pressure" ? (level-1)*0.05 : 0));
    u.rate = effective;
    u.pitch = 1.0;
    u.volume = 1.0;
    window.speechSynthesis.speak(u);
  }

  function setMode(newMode){
    mode = newMode;
    modeLabel.textContent = newMode === "classify" ? "Classify" : (newMode === "reply" ? "Reply Builder" : "Pressure");
    [tabClassify, tabReply, tabPressure].forEach(b=>b.classList.remove("activeTab"));
    (newMode==="classify"?tabClassify:(newMode==="reply"?tabReply:tabPressure)).classList.add("activeTab");

    // Mode behavior adjustments
    if(newMode === "reply"){
      // In reply mode, you still classify, but feedback emphasizes the "best one-unit reply".
      // Timer typically off unless user wants it.
    }
    if(newMode === "pressure"){
      // Encourage timer for pressure
      if(parseInt(timerSlider.value,10)===0){
        timerSlider.value = 8;
        updateTimerLabel();
      }
    }
    updateSpeedTag();
    setLevel();
  }

  function nextScenario(){
    clearResult();
    active = pickScenario();
    if(!active){
      msgText.textContent = "Turn on at least one Focus Function on the right.";
      return;
    }
    msgText.textContent = active.msg;

    // start timer and start clock for response time
    startedAt = performance.now();
    startTimerIfNeeded();

    // In pressure mode, auto speak to simulate fast talkers
    if(mode === "pressure"){
      speakCurrent();
    }
  }

  function recordTime(){
    if(startedAt){
      const t = performance.now() - startedAt;
      times.push(t);
      // keep last 30
      if(times.length > 30) times.shift();
    }
    startedAt = null;
  }

  function onPick(fPicked){
    if(!active) return;

    // Stop timer and record reaction time if answered before timeout
    if(resultBox.style.display === "block") return; // prevent double answers

    stopTimer();

    attempts++;
    const isCorrect = (fPicked === active.f);
    if(isCorrect){
      correct++;
      streak++;
    } else {
      streak = 0;
    }

    recordTime();
    setLevel();
    updateStats();
    showResult(isCorrect, fPicked);

    // In reply mode, gently nudge to type your one-liner
    if(mode === "reply"){
      yourReply.focus();
    }
  }

  // ====== EVENTS ======
  document.getElementById("nextBtn").addEventListener("click", nextScenario);
  document.getElementById("speakBtn").addEventListener("click", speakCurrent);

  document.getElementById("answerButtons").addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-f]");
    if(!btn) return;
    onPick(btn.dataset.f);
  });

  // Mode tabs
  tabClassify.addEventListener("click", ()=>setMode("classify"));
  tabReply.addEventListener("click", ()=>setMode("reply"));
  tabPressure.addEventListener("click", ()=>setMode("pressure"));

  // Sliders
  rateSlider.addEventListener("input", ()=>{
    rateLabel.textContent = `${parseFloat(rateSlider.value).toFixed(2)}√ó`;
    updateSpeedTag();
  });
  timerSlider.addEventListener("input", ()=>{
    updateTimerLabel();
    // restart timer with new settings on the next scenario; not mid-run
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    if(e.key === "n" || e.key === "N"){
      nextScenario();
    }
    if(e.code === "Space"){
      e.preventDefault();
      speakCurrent();
    }
    if(["1","2","3","4","5"].includes(e.key)){
      const map = {"1":"LOGISTICS","2":"CONNECTION","3":"BOUNDARY","4":"VENTING","5":"IDENTITY"};
      onPick(map[e.key]);
    }
    if(e.key === "Escape"){
      window.speechSynthesis && window.speechSynthesis.cancel();
      stopTimer();
    }
  });

  // Focus checkboxes: if all off, auto warn in next
  document.querySelectorAll(".focus").forEach(c=>{
    c.addEventListener("change", ()=>{
      // If current scenario is now excluded, just keep but next will change
    });
  });

  // Improve typed reply coaching (optional)
  yourReply.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      // quick coaching feedback about one-unit rule
      const txt = yourReply.value.trim();
      if(!txt) return;
      const tooLong = txt.split(/\s+/).length > 18;
      const hasFixingWords = /\b(should|you need to|you have to|do this|here's what you do|listen)\b/i.test(txt);
      const hasPity = /\b(sorry|poor you|that‚Äôs terrible|you didn‚Äôt deserve)\b/i.test(txt);

      let notes = [];
      if(tooLong) notes.push("Shorten it (one unit, one sentence).");
      if(hasFixingWords && active && active.f === "VENTING") notes.push("For venting: don‚Äôt fix ‚Äî reflect + validate + option.");
      if(hasPity && active && (active.f === "IDENTITY" || active.f === "BOUNDARY")) notes.push("Avoid pity/rescuing language ‚Äî mirror + respect.");
      if(!notes.length) notes.push("Good ‚Äî one-unit tone. Stop there.");

      microCoach.innerHTML = `<b>Coach:</b> ${active ? active.coach : ""}<br/><span class="tiny"><b>Your reply check:</b> ${notes.join(" ")}</span>`;
    }
  });

  // Init UI labels
  rateLabel.textContent = `${parseFloat(rateSlider.value).toFixed(2)}√ó`;
  updateTimerLabel();
  updateSpeedTag();
  updateStats();
  setMode("classify");
</script>
</body>
</html>

